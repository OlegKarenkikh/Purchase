# АРХИТЕКТУРА СИСТЕМЫ

## Обзор

АИС УДЗ построена на современном tech-stack с использованием микросервисной архитектуры, обеспечивающей масштабируемость, надежность и производительность.

---

## Архитектурная диаграмма

```
┌─────────────────────────────────────────────────────────────┐
│                    CLIENT LAYER                             │
├─────────────────────────────────────────────────────────────┤
│  Web Browser (React/Next.js)  │  Mobile App (Future)        │
└───────────────────┬─────────────────────────────────────────┘
                    │
                    │ HTTPS/TLS 1.3
                    ▼
┌─────────────────────────────────────────────────────────────┐
│                    API GATEWAY                              │
├─────────────────────────────────────────────────────────────┤
│  Nginx / Kong                                               │
│  - Rate Limiting                                            │
│  - Authentication                                           │
│  - Load Balancing                                           │
└───────────────────┬─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│                 APPLICATION LAYER                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   FastAPI    │  │   Celery     │  │   WebSocket  │     │
│  │   REST API   │  │   Workers    │  │   Server     │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                             │
└───────────────────┬─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│                  BUSINESS LOGIC LAYER                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  Document    │  │     LLM      │  │   Package    │     │
│  │   Parser     │  │   Analyzer   │  │   Builder    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  Multi-Stage │  │  Document    │  │   Report     │     │
│  │  Controller  │  │  Registry    │  │  Generator   │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                             │
└───────────────────┬─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│                    DATA LAYER                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  PostgreSQL  │  │    Redis     │  │    MinIO     │     │
│  │  (Primary)   │  │   (Cache)    │  │   (Files)    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                             │
│  ┌──────────────┐  ┌──────────────┐                        │
│  │Elasticsearch │  │   RabbitMQ   │                        │
│  │  (Search)    │  │   (Queue)    │                        │
│  └──────────────┘  └──────────────┘                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│               EXTERNAL INTEGRATIONS                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   Claude     │  │   ЕИС API   │  │   DaData     │     │
│  │   LLM API    │  │zakupki.gov.ru│  │     API      │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## Технологический стек

### Backend
- **Python 3.11+** - основной язык программирования
- **FastAPI** - современный асинхронный веб-фреймворк
- **Pydantic** - валидация данных и сериализация
- **SQLAlchemy 2.0** - ORM для работы с БД
- **Alembic** - миграции БД
- **Celery** - распределенная очередь задач
- **Redis** - кэширование и брокер сообщений

### Frontend
- **React 18** - библиотека UI
- **Next.js 14** - фреймворк с SSR/SSG
- **TypeScript** - типизированный JavaScript
- **TailwindCSS** - utility-first CSS фреймворк
- **Zustand** - state management
- **React Query** - управление серверным состоянием

### ML/AI
- **Claude 3.5 Sonnet** - анализ документации через API
- **Tesseract OCR** - распознавание текста
- **pytesseract** - Python wrapper для Tesseract
- **PyPDF2** - парсинг PDF документов
- **python-docx** - работа с DOCX

### Хранилище данных
- **PostgreSQL 14+** - основная БД
- **Redis 7.0+** - кэш и очереди
- **MinIO** - объектное хранилище файлов (S3-compatible)
- **Elasticsearch 8.0+** - полнотекстовый поиск (опционально)

### DevOps
- **Docker** - контейнеризация
- **Docker Compose** - локальная разработка
- **Nginx** - reverse proxy и load balancer
- **GitHub Actions** - CI/CD
- **Prometheus + Grafana** - мониторинг
- **ELK Stack** - централизованное логирование

---

## Компоненты системы

### 1. Document Parser Layer

**Назначение:** Извлечение текста и структуры из различных форматов документов.

**Компоненты:**
- `PDFParser` - парсинг текстовых PDF
- `PDFOCRParser` - парсинг сканированных PDF с OCR
- `DOCXParser` - парсинг Microsoft Word документов
- `RTFParser` - парсинг RTF файлов
- `TXTParser` - обработка текстовых файлов
- `ZIPParser` - распаковка и обработка архивов
- `DocumentParserFactory` - фабрика для выбора парсера

**Технологии:**
- PyPDF2, pdfplumber для PDF
- Tesseract OCR для сканов
- python-docx для DOCX
- striprtf для RTF

### 2. LLM Analyzer

**Назначение:** Интеллектуальный анализ закупочной документации с извлечением требований.

**Функции:**
- Извлечение идентификационных данных закупки
- Определение правовой основы (44-ФЗ, 223-ФЗ)
- Извлечение списка требуемых документов
- Категоризация документов
- Выявление неявных требований
- Дедупликация похожих документов

**Технологии:**
- Claude 3.5 Sonnet API
- Промпт-инженерия с few-shot примерами
- Structured output через JSON

### 3. Document Registry

**Назначение:** Централизованное хранилище документов компании.

**Функции:**
- Управление документами организации
- Версионирование
- Контроль сроков действия
- Полнотекстовый поиск
- Тегирование и категоризация

**Хранение:**
- Метаданные: PostgreSQL
- Файлы: MinIO/S3
- Индекс: Elasticsearch

### 4. Package Builder

**Назначение:** Формирование комплектов документов для подачи заявок.

**Функции:**
- Подбор документов из реестра
- Генерация недостающих документов из шаблонов
- Формирование описи
- Создание ZIP-архива
- Проверка комплектности

### 5. Multi-Stage Controller

**Назначение:** Многоэтапный контроль качества документов.

**Этапы:**
1. Автоматический контроль (формат, сроки, комплектность)
2. Юридический контроль (соответствие требованиям)
3. Финансовый контроль (корректность расчетов)
4. Итоговый контроль (финальная проверка)

**Workflow:**
- Последовательное прохождение этапов
- Возврат при выявлении проблем
- Эскалация критичных ошибок
- Уведомления ответственных лиц

---
## Безопасность

### Аутентификация и авторизация
- **JWT токены** с short-lived access tokens (15 мин)
- **Refresh токены** (7 дней)
- **RBAC** - ролевая модель доступа
- **2FA** опционально для критичных операций

### Защита данных
- **HTTPS/TLS 1.3** для всех соединений
- **Шифрование паролей** через bcrypt (cost 12)
- **Шифрование БД** чувствительных полей (AES-256)
- **Шифрование файлов** at rest в MinIO

### Защита от атак
- **Rate Limiting** - 100 req/min на IP
- **CORS** - настроенный whitelist
- **CSRF токены** для форм
- **SQL Injection** - защита через ORM
- **XSS** - санитизация ввода
- **Input Validation** - Pydantic схемы

### Аудит
- Логирование всех действий пользователей
- Append-only audit log (3 года хранения)
- Интеграция с SIEM системой

---

## Масштабирование

### Горизонтальное масштабирование
- **API серверы:** до 10 инстансов за load balancer
- **Worker процессы:** до 20 Celery workers
- **Redis:** cluster mode с 3+ узлами
- **PostgreSQL:** Master-Slave репликация

### Вертикальное масштабирование
- API: 4 CPU, 8 GB RAM
- Workers: 8 CPU, 16 GB RAM
- PostgreSQL: 8 CPU, 32 GB RAM
- Redis: 4 CPU, 8 GB RAM

### Кэширование
- **Redis** для результатов LLM анализа (TTL 24h)
- **Redis** для сессий пользователей
- **CDN** для статики frontend
- **HTTP кэш** через Nginx

---

## Мониторинг и логирование

### Метрики (Prometheus)
- Время отклика API (p50, p95, p99)
- RPS (requests per second)
- Error rate
- CPU/Memory usage
- DB connections pool
- Queue length

### Логи (ELK Stack)
- Application logs (структурированный JSON)
- Access logs (Nginx)
- Error logs
- Audit logs
- Performance logs

### Алерты (Alertmanager)
- Uptime < 99.5%
- Error rate > 1%
- Response time > 500ms (p99)
- Disk space < 20%
- Memory usage > 90%

---

## Развертывание

### Development
```bash
docker-compose up -d
```

### Staging/Production
```bash
# Docker Swarm или Kubernetes
kubectl apply -f k8s/
```

### CI/CD Pipeline
1. **Build:** Docker image сборка
2. **Test:** Unit + Integration тесты
3. **Security Scan:** Trivy, Bandit
4. **Deploy to Staging:** автоматически
5. **E2E Tests:** Playwright
6. **Deploy to Production:** manual approval
7. **Health Check:** smoke tests

---

*Версия: 1.0*  
*Дата: 15.01.2026*
