#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –∞–Ω–∞–ª–∏–∑–∞ –∑–∞–∫—É–ø–æ—á–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
"""

import sys
from pathlib import Path
import json

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—É—Ç–∏ –∫ –º–æ–¥—É–ª—è–º
sys.path.insert(0, str(Path(__file__).parent.parent / "src"))

from analyzer import DocumentAnalyzer


def example_1_basic_analysis():
    """
    –ü—Ä–∏–º–µ—Ä 1: –ë–∞–∑–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞ –∑–∞–∫—É–ø–æ—á–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
    """
    print("=" * 80)
    print("–ü–†–ò–ú–ï–† 1: –ë–∞–∑–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞")
    print("=" * 80)
    
    # –ü—Ä–∏–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –∑–∞–∫—É–ø–æ—á–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
    sample_text = """
    –ò–ó–í–ï–©–ï–ù–ò–ï –û –ü–†–û–í–ï–î–ï–ù–ò–ò –≠–õ–ï–ö–¢–†–û–ù–ù–û–ì–û –ê–£–ö–¶–ò–û–ù–ê ‚Ññ223-–ó–ü-2024-001
    
    –ó–∞–∫–∞–∑—á–∏–∫: –û–û–û "–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–∞—è –ö–æ–º–ø–∞–Ω–∏—è"
    
    –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –∑–∞–∫—É–ø–∫–∏:
    1. –í—ã–ø–∏—Å–∫–∞ –∏–∑ –ï–ì–†–Æ–õ (–Ω–µ —Å—Ç–∞—Ä–µ–µ 30 –¥–Ω–µ–π)
    2. –£—Å—Ç–∞–≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
    3. –õ–∏—Ü–µ–Ω–∑–∏—è –Ω–∞ –æ—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω–∏–µ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    4. –ë—É—Ö–≥–∞–ª—Ç–µ—Ä—Å–∫–∞—è –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥
    5. –°–ø—Ä–∞–≤–∫–∞ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ –Ω–∞–ª–æ–≥–∞–º
    6. –†–µ–µ—Å—Ç—Ä –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –≥–æ–¥–∞
    
    –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –≤–∫–ª—é—á–∞—Ç—å:
    - –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
    - –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –ì–û–°–¢
    - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
    """
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞
    analyzer = DocumentAnalyzer()
    
    # –ê–Ω–∞–ª–∏–∑
    result = analyzer.analyze(sample_text)
    
    print("\nüìÑ –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞:")
    print(json.dumps(result, ensure_ascii=False, indent=2))
    
    print(f"\n‚úÖ –ù–∞–π–¥–µ–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: {len(result.get('required_documents', []))}")
    print(f"üìä –û—Ü–µ–Ω–∫–∞ –ø–æ–ª–Ω–æ—Ç—ã: {result.get('completeness_score', 0)}%")


def example_2_file_analysis():
    """
    –ü—Ä–∏–º–µ—Ä 2: –ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–∞
    """
    print("\n" + "=" * 80)
    print("–ü–†–ò–ú–ï–† 2: –ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–∞ PDF/DOCX")
    print("=" * 80)
    
    analyzer = DocumentAnalyzer()
    
    # –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –ø—É—Ç—å)
    file_path = "example_procurement.pdf"
    
    if Path(file_path).exists():
        # –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—Å—Ç–∞ –∏–∑ —Ñ–∞–π–ª–∞
        text = analyzer.load_document(file_path)
        print(f"\nüìÑ –ò–∑–≤–ª–µ—á–µ–Ω–æ {len(text)} —Å–∏–º–≤–æ–ª–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞")
        
        # –ê–Ω–∞–ª–∏–∑
        result = analyzer.analyze(text)
        
        print("\n‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω")
        print(f"–ù–∞–π–¥–µ–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: {len(result.get('required_documents', []))}")
    else:
        print(f"\n‚ö†Ô∏è –§–∞–π–ª {file_path} –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª.")


def example_3_verification():
    """
    –ü—Ä–∏–º–µ—Ä 3: –°–≤–µ—Ä–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    """
    print("\n" + "=" * 80)
    print("–ü–†–ò–ú–ï–† 3: –°–≤–µ—Ä–∫–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤")
    print("=" * 80)
    
    # –¢—Ä–µ–±—É–µ–º—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã (—Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞)
    required_documents = [
        {"id": "doc_1", "name": "–í—ã–ø–∏—Å–∫–∞ –∏–∑ –ï–ì–†–Æ–õ", "mandatory": True},
        {"id": "doc_2", "name": "–£—Å—Ç–∞–≤", "mandatory": True},
        {"id": "doc_3", "name": "–õ–∏—Ü–µ–Ω–∑–∏—è", "mandatory": True},
        {"id": "doc_4", "name": "–ë—É—Ö–≥–∞–ª—Ç–µ—Ä—Å–∫–∞—è –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å", "mandatory": False},
    ]
    
    # –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
    provided_documents = [
        "–í—ã–ø–∏—Å–∫–∞ –∏–∑ –ï–ì–†–Æ–õ –æ—Ç 10.01.2026",
        "–£—Å—Ç–∞–≤ –û–û–û –†–æ–≥–∞–ò–ö–æ–ø—ã—Ç–∞",
        "–ë—É—Ö–≥–∞–ª—Ç–µ—Ä—Å–∫–∏–π –±–∞–ª–∞–Ω—Å 2025"
    ]
    
    analyzer = DocumentAnalyzer()
    
    # –°–≤–µ—Ä–∫–∞
    verification = analyzer.verify_documents(required_documents, provided_documents)
    
    print("\nüìä –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–≤–µ—Ä–∫–∏:")
    print(json.dumps(verification, ensure_ascii=False, indent=2))
    
    print(f"\n‚úÖ –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ: {len(verification['provided'])} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤")
    print(f"‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ: {len(verification['missing_critical'])} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤")
    print(f"‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ: {len(verification['missing_optional'])} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤")
    print(f"üìà –ü–æ–ª–Ω–æ—Ç–∞ –∫–æ–º–ø–ª–µ–∫—Ç–∞: {verification['completeness_score']}%")


def example_4_api_client():
    """
    –ü—Ä–∏–º–µ—Ä 4: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ API
    """
    print("\n" + "=" * 80)
    print("–ü–†–ò–ú–ï–† 4: –†–∞–±–æ—Ç–∞ —Å API")
    print("=" * 80)
    
    import requests
    
    API_URL = "http://localhost:8000"
    
    sample_text = "–ò–∑–≤–µ—â–µ–Ω–∏–µ –æ –∑–∞–∫—É–ø–∫–µ. –¢—Ä–µ–±—É—é—Ç—Å—è: –í—ã–ø–∏—Å–∫–∞ –ï–ì–†–Æ–õ, –£—Å—Ç–∞–≤, –õ–∏—Ü–µ–Ω–∑–∏—è."
    
    try:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
        response = requests.get(f"{API_URL}/health", timeout=5)
        
        if response.status_code == 200:
            print("\n‚úÖ API —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω")
            
            # –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –∞–Ω–∞–ª–∏–∑
            response = requests.post(
                f"{API_URL}/analyze",
                json={"text": sample_text},
                timeout=30
            )
            
            if response.status_code == 200:
                result = response.json()
                print("\nüìÑ –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ —á–µ—Ä–µ–∑ API:")
                print(json.dumps(result, ensure_ascii=False, indent=2))
            else:
                print(f"\n‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: {response.status_code}")
        else:
            print("\n‚ö†Ô∏è API —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
            
    except requests.exceptions.ConnectionError:
        print("\n‚ö†Ô∏è API —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: python src/api.py")
    except Exception as e:
        print(f"\n‚ùå –û—à–∏–±–∫–∞: {e}")


if __name__ == "__main__":
    print("\n" + "#" * 80)
    print("# –ü–†–ò–ú–ï–†–´ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø –ê–ò–° –£–î–ó")
    print("#" * 80)
    
    # –ó–∞–ø—É—Å–∫ –ø—Ä–∏–º–µ—Ä–æ–≤
    example_1_basic_analysis()
    example_2_file_analysis()
    example_3_verification()
    example_4_api_client()
    
    print("\n" + "#" * 80)
    print("# –ü–†–ò–ú–ï–†–´ –ó–ê–í–ï–†–®–ï–ù–´")
    print("#" * 80 + "\n")
